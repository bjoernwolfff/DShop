<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals</title>
    <link rel="stylesheet" href="items.css">
    <link rel="stylesheet" href="deal.css">
    <style>

    </style>
  </head>
  <body>
    <!-- Untere Navigation - höher positioniert -->
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">shop</a></li>
        <li class="choosed"><a href="deals.html">deals</a></li>
        <li><a href="acc.html">account</a></li>
      </ul>
    </nav>
    
    <!-- Hauptinhalt -->
    <div class="main-content">
      <div class="deals-container">
        <h1>Current Deals</h1>
        <p>Here are your Deals!</p>
        
        <!-- Deals werden jetzt dynamisch aus JSON geladen -->
        <div id="all-deals"></div>
      </div>

      <div class="deals-container">
        <h1>Create Deal</h1>
        
        <!-- Deal Creation Form -->
        <div class="deal-form" id="deal-form" style="display: none;">
          <form id="create-deal-form">
            <div class="form-group">
              <label for="deal-name">Deal Title:</label>
              <input type="text" id="deal-name" name="deal-name" required>
            </div>

            <div class="form-group">
              <label for="deal-price">Price ($):</label>
              <input type="number" id="deal-price" name="deal-price" step="0.01" min="0" required>
            </div>



            <div class="form-group">
              <label for="deal-description">Description:</label>
              <textarea id="deal-description" name="deal-description" placeholder="Enter deal description..."></textarea>
            </div>

            <div class="form-group">
              <label for="deal-category">Category:</label>
              <select id="deal-category" name="deal-category">
                <option value="weapon-item">Weapon</option>
                <option value="drug-item">Drug</option>
                <option value="software-item">Software</option>
                <option value="money-item">Money</option>
              </select>
            </div>

            <div class="form-group">
              <label>Deal Image:</label>
              <div class="image-upload" id="image-upload">
                <p>Click here or drag & drop an image</p>
                <input type="file" id="image-input" accept="image/*" class="hidden">
                <img id="image-preview" class="image-preview hidden" alt="Preview">
              </div>
            </div>

            <button type="submit" class="create-button">Add Deal</button>
          </form>
        </div>

        <button id="toggle-form" class="create-button">Create New Deal</button>
        <button id="download-json" class="create-button" style="margin-left: 10px;">Download JSON</button>
      </div>
    </div>

    <script>
      let allDeals = [];

      // JSON Datei laden
      async function loadDeals() {
        try {
          const response = await fetch('deals.json');
          const data = await response.json();
          allDeals = data.deals || [];
          renderDeals();
        } catch (error) {
          console.error('Error loading deals:', error);
          // Fallback auf leeres Array wenn JSON nicht geladen werden kann
          allDeals = [];
          renderDeals();
        }
      }

      // Deals rendern
      function renderDeals() {
        const container = document.getElementById('all-deals');
        container.innerHTML = '';

        allDeals.forEach(deal => {
          const dealElement = document.createElement('div');
          dealElement.className = deal.category;
          
          let imageHtml = '';
          if (deal.image) {
            imageHtml = `<img src="${deal.image}" class="deal-image" alt="${deal.title}">`;
          }

          let priceHtml = `${deal.price.toFixed(2)}`;
          
          dealElement.innerHTML = `
            <div class="deal-title">${deal.title}</div>
            <div class="deal-price">
              ${priceHtml}
            </div>
            ${imageHtml}
            <p>${deal.description}</p>
          `;
          
          container.appendChild(dealElement);
        });
      }

      // Deal hinzufügen
      function addDeal(dealData) {
        const newDeal = {
          id: 'deal' + Date.now(),
          title: dealData.title,
          price: parseFloat(dealData.price),
          description: dealData.description,
          category: dealData.category,
          image: dealData.image
        };
        
        allDeals.push(newDeal);
        renderDeals();
        downloadUpdatedJSON();
      }

      // JSON Download Funktion
      function downloadUpdatedJSON() {
        const jsonData = {
          deals: allDeals
        };
        
        const dataStr = JSON.stringify(jsonData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'deals.json';
        link.click();
        
        URL.revokeObjectURL(link.href);
      }

      // Form toggle functionality
      const toggleBtn = document.getElementById('toggle-form');
      const dealForm = document.getElementById('deal-form');
      
      toggleBtn.addEventListener('click', function() {
        if (dealForm.style.display === 'none') {
          dealForm.style.display = 'block';
          toggleBtn.textContent = 'Cancel';
        } else {
          dealForm.style.display = 'none';
          toggleBtn.textContent = 'Create New Deal';
          document.getElementById('create-deal-form').reset();
          document.getElementById('image-preview').classList.add('hidden');
        }
      });

      // Download JSON Button
      document.getElementById('download-json').addEventListener('click', downloadUpdatedJSON);

      // Image upload functionality
      const imageUpload = document.getElementById('image-upload');
      const imageInput = document.getElementById('image-input');
      const imagePreview = document.getElementById('image-preview');

      imageUpload.addEventListener('click', () => {
        imageInput.click();
      });

      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Drag and drop functionality
      imageUpload.addEventListener('dragover', function(e) {
        e.preventDefault();
        imageUpload.classList.add('dragover');
      });

      imageUpload.addEventListener('dragleave', function(e) {
        e.preventDefault();
        imageUpload.classList.remove('dragover');
      });

      imageUpload.addEventListener('drop', function(e) {
        e.preventDefault();
        imageUpload.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          const file = files[0];
          imageInput.files = files;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Form submission
      document.getElementById('create-deal-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const dealName = formData.get('deal-name');
        const dealPrice = formData.get('deal-price');
        const dealDescription = formData.get('deal-description');
        const dealCategory = formData.get('deal-category');
        const imageFile = imageInput.files[0];
        
        let imageDataUrl = null;
        if (imageFile && imagePreview.src) {
          imageDataUrl = imagePreview.src;
        }
        
        // Deal hinzufügen
        addDeal({
          title: dealName,
          price: dealPrice,
          description: dealDescription,
          category: dealCategory,
          image: imageDataUrl
        });
        
        // Reset form and hide it
        this.reset();
        imagePreview.classList.add('hidden');
        dealForm.style.display = 'none';
        toggleBtn.textContent = 'Create New Deal';
        
        // Success message
        alert('Deal created successfully! Updated JSON file will be downloaded automatically.');
      });

      // Deals beim Laden der Seite laden
      loadDeals();
    </script>
  </body>
</html>
